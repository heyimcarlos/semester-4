# Advanced Database Concepts

## Module 1

### What is a schema?

A schema is a blueprint of a database, essentially how the database is structured.
It shows how relationships between data are handled. A schema can include tables,
fields, relationships, views, indexes, and other elements.

A schema is a collection of objects (like tables, views, indexes, etc.).

### Oracle Databse 12c Objects

- Tables - A collection of related data entries consisting of rows and columns.
- Views - A virtual table based on the result set of a SQL statement.
- Indexes - A performance optimization feature that allows faster retrieval of records.
- Materialized Views - A database object that contains the results of a query.
- Index-Organized Tables - A table where the data is stored in the index order.
- Sequences - A database object that generates unique numbers.
- Synonyms - An alias for a database object.
- Triggers - A stored procedure that automatically executes when certain events occur.
- Stored functions - A stored procedure that returns a single value.
- Stored procedures - A stored procedure that does not return a value.
- Packages - A collection of related procedures and functions.

#### Sequences

```sql
-- Sequences are objects like tables
create sequence users_seq
  start with 1
  increment by 1
  minvalue 1
  maxvalue 99999999
  nocache -- do not cache sequence numbers
  nocycle; -- do not cycle when maxvalue is reached

create table users (
  id number default users_seq.NEXTVAL primary key
);

-- users_seq.CURRVAL returns the current value of the sequence
create or replace function get_next_user_id
return number is
  v_user_id number;
begin
  select users_seq.CURRVAL + 1 into v_user_id from dual;
  return v_user_id;
end;


-- drop sequence
drop sequence users_seq;

-- Create table with identity column (automagically handle the sequence)
create table users (
  id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
);
```

#### Indexes

Indexes are used to speed up the retrieval of rows from a table. They are
created on one or more columns of a table. When a query is executed, the database
can use the index to quickly locate the rows that match the query criteria.

- Oracle 11g creates an index for `PRIMARY KEY` and `UNIQUE` constraints automatically.
- IOT (Index-Organized Tables) are tables that store data in the index order.

Kinds:

- B-tree index - A balanced tree structure that allows for fast retrieval of rows.
- Bitmap index - A bitmap representation of the data in a table. It is used for
  columns with low cardinality (i.e., few distinct values).

```sql
-- Create an index on the name column
create index idx_name on users(name);
-- Create a unique index on the email column
create unique index idx_email on users(email);
-- Create a composite index on the name and email columns
create index idx_name_email on users(name, email);
-- Drop an index
drop index idx_name;
```

#### Synonyms

Synonyms are aliases for database objects. If public, have to be dropped by the DBA.

```sql
-- Create a synonym for the users table
create synonym users_syn for users;
-- Drop a synonym
drop synonym users_syn;
```

#### Views

Views are virtual tables that are based on the result set of a SQL query. They
can be used to simplify complex queries, hide sensitive data, or provide a
different representation of the data.

Views are permanent objects that don't store data. Instead they store the result
of a query.

- A query stored as an object.

```sql
create [or replace]  [force|noforce] view
  viewname (columnname, ...)
as select statement
  [with check option [constraint constraintname]]
  [with read only];
```

- Simple view - Only references one table. No group functions
  (like `SUM`, `AVG`, etc.), no joins, no subqueries.

```sql
create view inventory
  as select isbn, title, retail from books
with read only;
```

- Complex view - A view based on multiple tables or a subquery. May contain functions,
  or grouping.

```sql
create view users_view as
  select u.id, u.name, u.email, r.role
  from users u
  join roles r on u.role_id = r.id;
```

- Inline view - A view that is defined within a query. It is not a permanent object.
  Has access to `ORDER BY`

```sql
select *
from (select u.id, u.name, u.email, r.role
      from users u
      join roles r on u.role_id = r.id
      order by u.name
where r.role = 'admin');
```

- Materialized view - A view that stores the result of a query. It can be refreshed
  periodically or on demand. It is used to improve performance for complex queries.

```sql
create materialized view users_mv
  build immediate
  refresh fast on demand
  as
  select u.id, u.name, u.email, r.role
  from users u
  join roles r on u.role_id = r.id;

drop materialized view users_mv;
```

```sql
-- Create a view that shows all users
create view users_view as
  select * from users;

-- Create a view that shows all users with a specific role
create view users_view_role as
  select * from users where role = 'admin';

-- Create a view that shows the total number of users by role
create view users_view_role_count as
  select role, count(*) as total_users
  from users
  group by role;

-- Create a view that shows the total number of users by role and status
create view users_view_role_status_count as
  select role, status, count(*) as total_users
  from users
  group by role, status;

```

### Functions

- Function - A predefined block of code that takes arguments.
- Single-row function - Returns a single value for each row processed.
- Multiple-row function - Return one result per group of data processed.

### Types of Functions

| Type of function       | Functions                                                             |
| ---------------------- | --------------------------------------------------------------------- |
| case conversion        | UPPER, LOWER, INITCAP                                                 |
| character manipulation | CONCAT, SUBSTR, LENGTH, INSTR, LPAD/RPAD, REPLACE, TRANSLATE          |
| numeric                | ROUND, TRUNC, MOD, ABS, POWER, SQRT                                   |
| date                   | MONTHS_BETWEEN, ADD_MONTHS, LAST_DAY, NEXT_DAY, TO_DATE, CURRENT_DATE |
| regular expression     | REGEXP_LIKE, REGEXP_SUBSTR                                            |
| other                  | NULLIF, TO_CHAR, DECODE, CASE, TO_NUMBER                              |

### Operators

- || - Concatenation operator. Example: `'Hello' || 'World'` returns `HelloWorld`.
- - - Addition operator. Example: `1 + 2` returns `3`.
- - - Subtraction operator. Example: `5 - 2` returns `3`.

### Data types

- VARCHAR2 - Variable-length character string.
- DATE - Date and time data type. Includes fields YEAR, MONTH, DAY, HOUR, MINUTE, and SECOND.
- TIMESTAMP - Date and time data type with fractional seconds.
- TIMESTAMP WITH TIME ZONE - Date and time data type with time zone.
- TIMESTAMP WITH LOCAL TIME ZONE - Date and time data type with local time zone.

#### The NVL function

-

### How does Oracle handle NULL values?

- NULL values are not the same as empty strings or zero. NULL represents the absence
  of a value.
  When performing calculations, NULL values are ignored. For example, `NULL + 1`
  returns `NULL`.
- NULL values can be checked using the `IS NULL` or `IS NOT NULL` operators.
- NULL values can be replaced using the `NVL` function. For example, `NVL(column_name,
'default_value')` returns 'default_value' if column_name is NULL.

### Oracle SQL 12c Caveats

- Dates are stored in the same format always (i.e., `YYYY-MM-DD`).
